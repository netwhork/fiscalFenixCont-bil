<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora MVA Dinâmica</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .calculadora-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .info-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-height: 800px;
      overflow-y: auto;
    }

    .nota-fiscal-info, .produtos-info {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .nota-fiscal-info h3, .produtos-info h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .produto-item {
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      border-left: 4px solid #4CAF50;
    }

    .produto-item ul {
      list-style: none;
      padding-left: 0;
    }

    .produto-item li {
      margin: 5px 0;
      font-size: 0.9em;
    }

    .calculo {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #fff;
    }

    .xml {
      text-align: center;
      background-color: #f8f9fa;
      padding: 30px;
      border-radius: 5px;
      margin-bottom: 20px;
      border: 2px dashed #ccc;
      transition: all 0.3s ease;
    }
    
    .xml.dragover {
      background-color: #e0f7fa;
      border-color: #4CAF50;
    }

    label {
      display: block;
      margin-top: 10px;
      color: #555;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .buttons {
      text-align: center;
      margin-top: 20px;
    }

    button {
      display: inline-block;
      margin: 5px 10px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button#remover-mva {
      background-color: #f44336;
    }

    button:hover {
      opacity: 0.9;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
    }

    .info-section::-webkit-scrollbar {
      width: 8px;
    }

    .info-section::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .info-section::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .info-section::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .mva-select {
      width: 120px;
      padding: 2px 5px;
      margin-left: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    .mva-display {
      display: inline-block;
      font-weight: bold;
      color: #4CAF50;
      margin-left: 5px;
    }

    .icms-credit {
      color: #2c3e50;
      font-weight: bold;
      margin-left: 5px;
    }

    .credit-info {
      background-color: #e8f5e9;
      padding: 5px;
      border-radius: 4px;
      margin-top: 5px;
    }
    
    .calculos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .total-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #f1f8e9;
      border-radius: 8px;
      border: 1px solid #4CAF50;
    }
    
    .total-section h2 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .total-valor-guia {
      font-size: 1.2em;
      font-weight: bold;
      color: #4CAF50;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .info-section {
        max-height: 600px;
      }
      
      .calculos-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .main-content {
        gap: 10px;
      }
      
      .buttons button {
        width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de MVA</h1>
    
    <div class="main-content">
      <div class="calculadora-section">
        <div class="xml" id="drop-zone">
          <label for="xml-upload">Arraste um arquivo XML e solte-o aqui</label>
          <input type="file" id="xml-upload" accept=".xml">
        </div>

        <button onclick="processarXML()">Processar XML</button>

        <div id="calculos-container" class="calculos-grid">
          <!-- Blocos de cálculo dinâmicos serão inseridos aqui -->
        </div>

        <div class="total-section">
          <h2>Total dos Valores Guia:</h2>
          <input type="text" id="total-valor-guia" class="total-valor-guia" readonly>
        </div>

        <div class="buttons">
          <button id="adicionar-mva" onclick="adicionarCalculo()">Adicionar MVA</button>
          <button id="remover-mva" onclick="removerUltimoCalculo()">Remover MVA</button>
          <button class="voltar-btn" onclick="voltarPagina()">Voltar</button>
        </div>
      </div>

      <div class="info-section" id="informacoes-nota">
        <!-- As informações do XML serão inseridas aqui -->
      </div>
    </div>
  </div>

<script>
  function voltarPagina() {
    window.history.back();
  }

  function formatarValorProdutos(input) {
    let valor = input.replace(/\D/g, '');
    if (!valor) return '0,00';
    while (valor.length < 3) {
      valor = '0' + valor;
    }
    const tamanho = valor.length;
    const valorFormatado = valor.slice(0, tamanho - 2) + ',' + valor.slice(tamanho - 2);
    return valorFormatado;
  }

  const opcoesMVA = [
    "18,00", "19,28", "27,61", "30,41", "30,61", "33,47",
    "33,69", "34,23", "34,68", "35,00", "35,45", "35,93",
    "37,30", "38,14", "38,56", "39,43", "39,78", "39,91",
    "39,99", "40,21", "40,33", "40,69", "40,94", "41,87",
    "41,93", "42,07", "42,08", "42,36", "45,02", "45,52",
    "46,05", "46,15", "46,48", "47,05", "47,17", "47,30",
    "47,99", "49,31", "49,73", "50,39", "51,47", "52,14",
    "53,28", "53,86", "56,40", "57,97", "59,64", "61,78",
    "62,27", "65,29", "66,19", "67,49", "73,63", "88,72",
    "94,70"
  ];

// Dados mapeados de CEST para MVA
const cestMvaMap = {
"0100100": "50,39",
"0100200": "50,39",
"0100300": "50,39",
"0100400": "50,39",
"0100500": "50,39",
"0100600": "50,39",
"0100700": "50,39",
"0100800": "50,39",
"0100900": "50,39",
"0101000": "50,39",
"0101100": "50,39",
"0101200": "50,39",
"0101300": "50,39",
"0101400": "50,39",
"0101500": "50,39",
"0101600": "50,39",
"0101700": "50,39",
"0101800": "50,39",
"0101900": "50,39",
"0102000": "50,39",
"0102100": "50,39",
"0102200": "50,39",
"0102300": "50,39",
"0102400": "50,39",
"0102500": "50,39",
"0102600": "50,39",
"0102700": "50,39",
"0102800": "50,39",
"0102900": "50,39",
"0103000": "50,39",
"0103100": "50,39",
"0103200": "50,39",
"0103300": "50,39",
"0103400": "50,39",
"0103500": "50,39",
"0103600": "50,39",
"0103700": "50,39",
"0103800": "50,39",
"0103900": "50,39",
"0104000": "50,39",
"0104100": "50,39",
"0104200": "50,39",
"0104200": "50,39",
"0104300": "50,39",
"0104400": "50,39",
"0104500": "50,39",
"0104500": "65,29",
"0104501": "50,39",
"0104600": "50,39",
"0104700": "50,39",
"0104800": "50,39",
"0104900": "50,39",
"0105000": "50,39",
"0105100": "50,39",
"0105200": "50,39",
"0105300": "50,39",
"0105301": "50,39",
"0105400": "50,39",
"0105500": "50,39",
"0105600": "50,39",
"0105600": "50,39",
"0105700": "50,39",
"0105800": "50,39",
"0105900": "50,39",
"0106000": "50,39",
"0106100": "50,39",
"0106200": "50,39",
"0106201": "50,39",
"0106300": "50,39",
"0106300": "50,39",
"0106400": "50,39",
"0106500": "50,39",
"0106600": "50,39",
"0106700": "50,39",
"0106800": "50,39",
"0106900": "50,39",
"0107000": "50,39",
"0107100": "50,39",
"0107200": "50,39",
"0107300": "50,39",
"0107400": "50,39",
"0107500": "50,39",
"0107600": "50,39",
"0107700": "50,39",
"0107800": "50,39",
"0107900": "50,39",
"0108000": "50,39",
"0108100": "50,39",
"0108200": "50,39",
"0108300": "50,39",
"0108400": "50,39",
"0108500": "50,39",
"0108500": "50,39",
"0108600": "50,39",
"0108700": "50,39",
"0108800": "50,39",
"0108900": "50,39",
"0109000": "50,39",
"0109000": "50,39",
"0109100": "50,39",
"0109200": "65,29",
"0109300": "65,29",
"0109400": "65,29",
"0109500": "65,29",
"0109600": "50,39",
"0109700": "50,39",
"0109800": "50,39",
"0109900": "50,39",
"0110000": "50,39",
"0110100": "50,39",
"0110200": "50,39",
"0110300": "50,39",
"0110400": "50,39",
"0110500": "50,39",
"0110500": "50,39",
"0110600": "50,39",
"0110600": "50,39",
"0110700": "50,39",
"0110800": "50,39",
"0110900": "50,39",
"0111100": "50,39",
"0111200": "50,39",
"0111300": "50,39",
"0111400": "50,39",
"0111500": "50,39",
"0111600": "50,39",
"0111700": "50,39",
"0111800": "50,39",
"0111900": "50,39",
"0112000": "50,39",
"0112100": "50,39",
"0112200": "50,39",
"0112300": "50,39",
"0112400": "50,39",
"0112500": "50,39",
"0112600": "50,39",
"0112700": "50,39",
"0112800": "50,39",
"0199900": "50,39",
"0200100": "67,49",
"0200200": "67,49",
"0200300": "67,49",
"0200400": "67,49",
"0200500": "67,49",
"0200600": "67,49",
"0200700": "67,49",
"0200800": "67,49",
"0200900": "67,49",
"0201000": "67,49",
"0201100": "67,49",
"0201200": "67,49",
"0201300": "67,49",
"0201400": "67,49",
"0201500": "67,49",
"0201600": "67,49",
"0201700": "67,49",
"0201800": "67,49",
"0201900": "67,49",
"0202000": "67,49",
"0202100": "67,49",
"0202200": "67,49",
"0202300": "67,49",
"0202400": "67,49",
"0299900": "67,49",
"0300100": "73,63",
"0300200": "73,63",
"0300300": "73,63",
"0300300": "73,63",
"0300301": "73,63",
"0300400": "73,63",
"0300500": "73,63",
"0300500": "73,63",
"0300501": "73,63",
"0300502": "73,63",
"0300503": "73,63",
"0300504": "73,63",
"0300505": "73,63",
"0300600": "73,63",
"0300600": "73,63",
"0300700": "73,63",
"0300700": "73,63",
"0300800": "73,63",
"0300800": "73,63",
"0301000": "73,63",
"0301000": "73,63",
"0301001": "73,63",
"0301002": "73,63",
"0301003": "73,63",
"0301100": "73,63",
"0301100": "73,63",
"0301100": "73,63",
"0301101": "73,63",
"0301200": "73,63",
"0301200": "73,63",
"0301200": "73,63",
"0301201": "73,63",
"0301300": "73,63",
"0301300": "73,63",
"0301300": "73,63",
"0301301": "73,63",
"0301302": "73,63",
"0301400": "73,63",
"0301400": "73,63",
"0301500": "73,63",
"0301500": "73,63",
"0301500": "73,63",
"0301500": "73,63",
"0301600": "73,63",
"0301600": "73,63",
"0301600": "73,63",
"0302100": "73,63",
"0302100": "73,63",
"0302101": "73,63",
"0302102": "73,63",
"0302103": "73,63",
"0302104": "73,63",
"0302105": "73,63",
"0302106": "73,63",
"0302200": "73,63",
"0302200": "73,63",
"0302201": "73,63",
"0302202": "73,63",
"0302203": "73,63",
"0302204": "73,63",
"0302205": "73,63",
"0302206": "73,63",
"0302300": "73,63",
"0302400": "73,63",
"0302500": "73,63",
"0400100": "94,70",
"0400200": "94,70",
"0500100": "19,28",
"0800100": "41,87",
"0800200": "41,87",
"0800300": "41,87",
"0800400": "41,87",
"0800500": "41,87",
"0800600": "41,87",
"0800700": "41,87",
"0800800": "41,87",
"0800900": "41,87",
"0801000": "41,87",
"0801100": "41,87",
"0801200": "41,87",
"0801300": "41,87",
"0801400": "41,87",
"0801500": "41,87",
"0801600": "41,87",
"0801700": "41,87",
"0801800": "41,87",
"0801900": "41,87",
"0801901": "65,29",
"0802000": "41,87",
"0802100": "41,87",
"0802200": "41,87",
"0802300": "41,87",
"0900100": "66,19",
"0900200": "66,19",
"0900300": "88,72",
"0900400": "88,72",
"0900500": "49,31",
"0900500": "49,31",
"1000100": "52,14",
"1000200": "52,14",
"1000300": "52,14",
"1000400": "52,14",
"1000500": "49,73",
"1000600": "49,73",
"1000700": "52,14",
"1000800": "52,14",
"1000900": "52,14",
"1001000": "52,14",
"1001100": "52,14",
"1001200": "52,14",
"1001300": "52,14",
"1001400": "52,14",
"1001500": "52,14",
"1001600": "52,14",
"1001700": "52,14",
"1001800": "52,14",
"1001900": "52,14",
"1002000": "52,14",
"1002100": "52,14",
"1002200": "52,14",
"1002400": "41,93",
"1002400": "52,14",
"1002500": "52,14",
"1002600": "52,14",
"1002700": "52,14",
"1002800": "52,14",
"1002900": "52,14",
"1003000": "46,15",
"1003001": "46,15",
"1003100": "47,99",
"1003200": "52,14",
"1003300": "52,14",
"1003400": "52,14",
"1003500": "52,14",
"1003600": "52,14",
"1003700": "52,14",
"1003800": "52,14",
"1003900": "52,14",
"1004000": "52,14",
"1004100": "52,14",
"1004101": "30,41",
"1004200": "30,41",
"1004300": "30,41",
"1004300": "30,41",
"1004400": "30,41",
"1004500": "52,14",
"1004501": "52,14",
"1004600": "52,14",
"1004700": "52,14",
"1004800": "52,14",
"1004900": "30,41",
"1005000": "30,41",
"1005100": "52,14",
"1005200": "52,14",
"1005300": "30,41",
"1005400": "52,14",
"1005500": "52,14",
"1005600": "52,14",
"1005700": "52,14",
"1005800": "52,14",
"1005800": "52,14",
"1005900": "52,14",
"1005901": "52,14",
"1006000": "52,14",
"1006100": "52,14",
"1006200": "52,14",
"1006300": "52,14",
"1006400": "52,14",
"1006500": "52,14",
"1006600": "52,14",
"1006700": "52,14",
"1006800": "52,14",
"1006900": "52,14",
"1007000": "52,14",
"1007100": "52,14",
"1007200": "52,14",
"1007300": "52,14",
"1007400": "52,14",
"1007500": "52,14",
"1007600": "52,14",
"1007700": "52,14",
"1007800": "52,14",
"1007900": "52,14",
"1008000": "52,14",
"1100100": "38,14",
"1100100": "38,14",
"1100100": "59,64",
"1100100": "59,64",
"1100200": "46,48",
"1100200": "59,64",
"1100200": "59,64",
"1100200": "59,64",
"1100300": "46,48",
"1100300": "59,64",
"1100300": "59,64",
"1100300": "59,64",
"1100400": "41,93",
"1100400": "41,93",
"1100400": "59,64",
"1100400": "59,64",
"1100400": "59,64",
"1100400": "59,64",
"1100500": "41,93",
"1100500": "41,93",
"1100500": "59,64",
"1100500": "59,64",
"1100600": "41,93",
"1100600": "41,93",
"1100600": "59,64",
"1100600": "59,64",
"1100600": "59,64",
"1100600": "59,64",
"1100700": "59,64",
"1100800": "37,30",
"1100800": "59,64",
"1100900": "59,64",
"1101000": "59,64",
"1101100": "59,64",
"1101200": "59,64",
"1200100": "42,08",
"1200200": "42,08",
"1200300": "42,08",
"1200400": "42,08",
"1200500": "42,08",
"1200600": "42,08",
"1200700": "42,08",
"1200800": "42,08",
"1200900": "42,08",
"1300100": "46,05",
"1300101": "46,05",
"1300102": "46,05",
"1300200": "46,05",
"1300201": "46,05",
"1300202": "46,05",
"1300300": "46,05",
"1300301": "46,05",
"1300302": "46,05",
"1300400": "46,05",
"1300401": "46,05",
"1300402": "46,05",
"1300500": "46,05",
"1300501": "46,05",
"1300502": "46,05",
"1300503": "46,05",
"1300504": "46,05",
"1300505": "46,05",
"1300600": "46,05",
"1300700": "46,05",
"1300701": "46,05",
"1300800": "46,05",
"1300801": "46,05",
"1300900": "46,05",
"1300901": "46,05",
"1301000": "46,05",
"1301001": "46,05",
"1301100": "46,05",
"1301200": "46,05",
"1301200": "46,05",
"1301300": "46,05",
"1301400": "46,05",
"1301500": "46,05",
"1301600": "46,05",
"1400100": "51,47",
"1400200": "51,47",
"1400300": "51,47",
"1400400": "51,47",
"1400500": "51,47",
"1400600": "51,47",
"1400601": "51,47",
"1400700": "51,47",
"1400800": "51,47",
"1400900": "51,47",
"1401000": "51,47",
"1401100": "51,47",
"1401200": "51,47",
"1401300": "51,47",
"1600100": "62,27",
"1600200": "62,27",
"1600300": "62,27",
"1600400": "62,27",
"1600500": "62,27",
"1600600": "62,27",
"1600700": "62,27",
"1600701": "62,27",
"1600800": "62,27",
"1600900": "62,27",
"1700100": "45,52",
"1700100": "45,52",
"1700100": "45,52",
"1700101": "45,52",
"1700101": "45,52",
"1700200": "45,52",
"1700200": "45,52",
"1700200": "45,52",
"1700201": "45,52",
"1700201": "45,52",
"1700300": "45,52",
"1700300": "45,52",
"1700300": "45,52",
"1700400": "45,52",
"1700400": "45,52",
"1700400": "45,52",
"1700401": "45,52",
"1700401": "45,52",
"1700500": "45,52",
"1700501": "45,52",
"1700600": "45,52",
"1700601": "45,52",
"1700602": "45,52",
"1700700": "45,52",
"1700800": "45,52",
"1700900": "45,52",
"1701000": "45,52",
"1701100": "45,52",
"1701200": "34,23",
"1701200": "34,23",
"1701300": "45,52",
"1701400": "45,52",
"1701500": "45,52",
"1701600": "27,61",
"1701600": "35",
"1701600": "45,52",
"1701601": "27,61",
"1701601": "35",
"1701601": "45,52",
"1701700": "27,61",
"1701700": "35",
"1701700": "45,52",
"1701701": "27,61",
"1701701": "45,52",
"1701800": "27,61",
"1701801": "27,61",
"1701900": "45,52",
"1701901": "45,52",
"1701902": "34,23",
"1701902": "45,52",
"1701903": "34,23",
"1701903": "45,52",
"1702000": "45,52",
"1702001": "45,52",
"1702100": "40,21",
"1702100": "45,52",
"1702101": "40,21",
"1702101": "45,52",
"1702200": "40,21",
"1702200": "45,52",
"1702300": "45,52",
"1702301": "45,52",
"1702400": "45,52",
"1702400": "45,52",
"1702401": "45,52",
"1702402": "45,52",
"1702403": "45,52",
"1702404": "45,52",
"1702405": "45,52",
"1702500": "45,52",
"1702501": "45,52",
"1702502": "45,52",
"1702600": "3061",
"1702600": "45,52",
"1702700": "3061",
"1702700": "45,52",
"1702701": "3061",
"1702701": "45,52",
"1702702": "45,52",
"1702800": "45,52",
"1702801": "45,52",
"1702900": "45,52",
"1703000": "45,52",
"1703100": "39,78",
"1703100": "39,78",
"1703100": "45,52",
"1703101": "39,78",
"1703101": "45,52",
"1703102": "39,78",
"1703102": "45,52",
"1703200": "45,52",
"1703300": "45,52",
"1703301": "45,52",
"1703400": "40,69",
"1703400": "45,52",
"1703500": "45,52",
"1703600": "45,52",
"1703700": "45,52",
"1703800": "45,52",
"1703900": "45,52",
"1704000": "45,52",
"1704100": "40,69",
"1704100": "45,52",
"1704200": "45,52",
"1704300": "45,52",
"1704400": "33,47",
"1704400": "45,52",
"1704401": "33,47",
"1704401": "45,52",
"1704402": "33,47",
"1704402": "45,52",
"1704403": "33,47",
"1704403": "45,52",
"1704404": "33,47",
"1704404": "45,52",
"1704405": "33,47",
"1704405": "45,52",
"1704406": "33,47",
"1704406": "45,52",
"1704407": "33,47",
"1704407": "45,52",
"1704408": "33,47",
"1704408": "45,52",
"1704409": "33,47",
"1704409": "45,52",
"1704410": "33,47",
"1704410": "45,52",
"1704411": "33,47",
"1704411": "45,52",
"1704412": "33,47",
"1704412": "45,52",
"1704413": "33,47",
"1704413": "45,52",
"1704414": "33,47",
"1704414": "45,52",
"1704415": "33,47",
"1704415": "45,52",
"1704416": "33,47",
"1704416": "45,52",
"1704417": "33,47",
"1704417": "45,52",
"1704418": "33,47",
"1704418": "45,52",
"1704419": "33,47",
"1704419": "45,52",
"1704420": "33,47",
"1704420": "45,52",
"1704421": "33,47",
"1704421": "45,52",
"1704422": "33,47",
"1704422": "45,52",
"1704423": "33,47",
"1704423": "45,52",
"1704424": "33,47",
"1704424": "45,52",
"1704425": "33,47",
"1704425": "45,52",
"1704426": "33,47",
"1704426": "45,52",
"1704427": "33,47",
"1704427": "45,52",
"1704500": "45,52",
"1704600": "40,94",
"1704600": "45,52",
"1704601": "40,94",
"1704601": "45,52",
"1704602": "40,94",
"1704602": "45,52",
"1704603": "40,94",
"1704603": "45,52",
"1704604": "40,94",
"1704604": "45,52",
"1704605": "40,94",
"1704605": "45,52",
"1704606": "40,94",
"1704606": "45,52",
"1704607": "40,94",
"1704607": "45,52",
"1704608": "40,94",
"1704608": "45,52",
"1704609": "40,94",
"1704609": "45,52",
"1704610": "40,94",
"1704610": "45,52",
"1704611": "40,94",
"1704611": "45,52",
"1704612": "40,94",
"1704612": "45,52",
"1704613": "40,94",
"1704613": "45,52",
"1704614": "40,94",
"1704614": "45,52",
"1704615": "40,94",
"1704615": "40,94",
"1704615": "45,52",
"1704615": "45,52",
"1704616": "40,94",
"1704700": "33,69",
"1704700": "45,52",
"1704700": "45,52",
"1704701": "33,69",
"1704701": "45,52",
"1704800": "45,52",
"1704801": "45,52",
"1704802": "45,52",
"1704900": "35,45",
"1704900": "45,52",
"1704900": "45,52",
"1704901": "35,45",
"1704901": "45,52",
"1704901": "45,52",
"1704901": "45,52",
"1704902": "35,93",
"1704902": "45,52",
"1704902": "45,52",
"1704903": "35,45",
"1704903": "45,52",
"1704903": "45,52",
"1704903": "45,52",
"1704904": "35,45",
"1704904": "45,52",
"1704904": "45,52",
"1704904": "45,52",
"1704905": "35,45",
"1704905": "45,52",
"1704905": "45,52",
"1704906": "35,93",
"1704906": "45,52",
"1704906": "45,52",
"1704907": "35,93",
"1704907": "45,52",
"1704907": "45,52",	
"1704908": "45,52",
"1704909": "45,52",
"1705000": "39,78",
"1705000": "45,52",
"1705100": "39,78",
"1705100": "45,52",
"1705200": "39,78",
"1705200": "45,52",
"1705300": "39,78",
"1705300": "45,52",
"1705301": "39,78",
"1705301": "45,52",
"1705302": "39,78",
"1705302": "45,52",
"1705400": "39,78",
"1705400": "45,52",
"1705401": "39,78",
"1705401": "45,52",
"1705402": "39,78",
"1705402": "45,52",
"1705600": "39,78",
"1705600": "45,52",
"1705601": "39,78",
"1705601": "45,52",
"1705602": "39,78",
"1705602": "45,52",
"1705700": "39,78",
"1705700": "45,52",
"1705800": "39,78",
"1705800": "45,52",
"1705900": "39,78",
"1705900": "45,52",
"1706000": "39,78",
"1706000": "45,52",
"1706200": "39,78",
"1706200": "45,52",
"1706201": "39,78",
"1706201": "45,52",
"1706202": "39,78",
"1706202": "45,52",
"1706203": "39,78",
"1706203": "45,52",
"1706300": "39,78",
"1706300": "45,52",
"1706400": "39,78",
"1706400": "45,52",
"1706500": "18,00",
"1706500": "45,52",
"1706600": "45,52",
"1706700": "45,52",
"1706701": "45,52",
"1706702": "45,52",
"1706800": "45,52",
"1706800": "45,52",
"1706900": "45,52",
"1706901": "45,52",
"1707000": "45,52",
"1707100": "45,52",
"1707200": "45,52",
"1707300": "45,52",
"1707400": "45,52",
"1707500": "45,52",
"1707600": "45,52",
"1707700": "45,52",
"1707701": "45,52",
"1707800": "45,52",
"1707900": "45,52",
"1707901": "45,52",
"1707902": "45,52",
"1707903": "45,52",
"1707904": "45,52",
"1707905": "45,52",
"1707906": "45,52",
"1707907": "45,52",
"1708000": "38,56",
"1708000": "45,52",
"1708001": "38,56",
"1708001": "45,52",
"1708100": "38,56",
"1708100": "45,52",
"1708200": "45,52",
"1708300": "45,52",
"1708301": "45,52",
"1708400": "45,52",
"1708500": "45,52",
"1708600": "45,52",
"1708700": "45,52",
"1708701": "45,52",
"1708702": "45,52",
"1708800": "45,52",
"1708801": "45,52",
"1708900": "45,52",
"1708901": "45,52",
"1709000": "45,52",
"1709001": "45,52",
"1709100": "45,52",
"1709101": "45,52",
"1709200": "45,52",
"1709201": "45,52",
"1709300": "45,52",
"1709301": "45,52",
"1709400": "45,52",
"1709401": "45,52",
"1709500": "45,52",
"1709501": "45,52",
"1709600": "34,68",
"1709600": "45,52",
"1709601": "34,68",
"1709601": "45,52",
"1709602": "34,68",
"1709602": "45,52",
"1709603": "34,68",
"1709603": "45,52",
"1709604": "34,68",
"1709604": "45,52",
"1709605": "34,68",
"1709605": "45,52",
"1709700": "45,52",
"1709800": "45,52",
"1709900": "42,36",
"1709900": "45,52",
"1709901": "42,36",
"1709901": "45,52",
"1709902": "42,36",
"1709902": "45,52",
"1710000": "45,52",
"1710001": "45,52",
"1710002": "45,52",
"1710100": "42,36",
"1710100": "45,52",
"1710101": "42,36",
"1710101": "45,52",
"1710102": "42,36",
"1710102": "45,52",
"1710200": "45,52",
"1710201": "45,52",
"1710202": "45,52",
"1710300": "42,36",
"1710300": "45,52",
"1710301": "42,36",
"1710301": "45,52",
"1710302": "42,36",
"1710302": "45,52",
"1710400": "45,52",
"1710401": "45,52",
"1710402": "45,52",
"1710500": "45,52",
"1710501": "45,52",
"1710502": "45,52",
"1710600": "45,52",
"1710700": "45,52",
"1710701": "45,52",
"1710800": "45,52",
"1710801": "45,52",
"1710900": "45,52",
"1711000": "45,52",
"1711100": "45,52",
"1711200": "45,52",
"1711300": "45,52",
"1711400": "45,52",
"1711500": "45,52",
"1711600": "45,52",
"1711700": "45,52",	
"1711700": "45,52",	
"1900100": "57,97",
"1900200": "57,97",
"1900300": "57,97",
"1900400": "57,97",
"1900500": "57,97",
"1900501": "57,97",
"1900600": "57,97",
"1900700": "57,97",
"1900800": "57,97",
"1900900": "57,97",
"1901000": "57,97",
"1901100": "57,97",
"1901200": "57,97",
"1901300": "57,97",
"1901400": "57,97",
"1901500": "57,97",
"1901600": "57,97",
"1901700": "57,97",
"1901800": "57,97",
"1901900": "57,97",
"1902000": "57,97",
"1902100": "57,97",
"1902200": "57,97",
"1902300": "57,97",
"1902400": "57,97",
"1902500": "57,97",
"1902600": "57,97",
"1902700": "57,97",
"1902800": "57,97",
"1902900": "57,97",
"1903000": "57,97",
"1903100": "57,97",
"1903200": "57,97",
"1903300": "57,97",
"2000100": "59,64",
"2000101": "59,64",
"2000200": "59,64",
"2000300": "59,64",
"2000400": "59,64",
"2000500": "59,64",
"2000600": "59,64",
"2000700": "59,64",
"2000800": "59,64",
"2000900": "59,64",
"2001000": "59,64",
"2001100": "59,64",
"2001200": "59,64",
"2001300": "59,64",
"2001400": "59,64",
"2001500": "59,64",
"2001600": "59,64",
"2001700": "39,91",
"2001700": "59,64",
"2001800": "59,64",
"2001900": "59,64",
"2002000": "47,05",
"2002000": "59,64",
"2002100": "47,05",
"2002100": "59,64",
"2002200": "47,05",
"2002200": "59,64",
"2002300": "39,43",
"2002300": "59,64",
"2002400": "59,64",
"2002500": "59,64",
"2002600": "59,64",
"2002700": "59,64",
"2002701": "59,64",
"2002800": "59,64",
"2002900": "59,64",
"2002901": "59,64",
"2003000": "59,64",
"2003100": "59,64",
"2003200": "59,64",
"2003201": "59,64",
"2003300": "59,64",
"2003400": "39,99",
"2003400": "59,64",
"2003401": "39,99",
"2003401": "59,64",
"2003500": "59,64",
"2003600": "59,64",
"2003700": "59,64",
"2003800": "59,64",
"2003900": "59,64",
"2004000": "59,64",
"2004100": "59,64",
"2004200": "45,02",
"2004200": "59,64",
"2004300": "45,02",
"2004300": "59,64",
"2004400": "59,64",
"2004500": "59,64",
"2004600": "59,64",
"2004700": "59,64",
"2004800": "42,07",
"2004800": "59,64",
"2004801": "42,07",
"2004801": "59,64",
"2004900": "42,07",
"2004900": "59,64",
"2005000": "42,07",
"2005000": "59,64",
"2005100": "59,64",
"2005200": "59,64",
"2005300": "59,64",
"2005400": "59,64",
"2005500": "59,64",
"2005600": "59,64",
"2005700": "59,64",
"2005800": "59,64",
"2005900": "59,64",
"2006000": "59,64",
"2006100": "59,64",
"2006200": "59,64",
"2006300": "59,64",
"2006300": "59,64",
"2006400": "59,64",
"2006500": "46,05",	
"2006500": "59,64",
"2100100": "40,33",
"2100200": "40,33",
"2100300": "40,33",
"2100400": "40,33",
"2100500": "40,33",
"2100600": "40,33",
"2100700": "40,33",
"2100800": "40,33",
"2100900": "40,33",
"2101000": "40,33",
"2101100": "40,33",
"2101200": "40,33",
"2101300": "40,33",
"2101400": "40,33",
"2101500": "40,33",
"2101600": "53,86",
"2101700": "53,86",
"2101800": "53,86",
"2101900": "40,33",
"2102000": "40,33",
"2102100": "40,33",
"2102200": "40,33",
"2102300": "40,33",
"2102400": "40,33",
"2102500": "40,33",
"2102600": "40,33",
"2102700": "40,33",
"2102800": "53,86",
"2102900": "53,86",
"2103000": "53,86",
"2103100": "53,86",
"2103200": "53,86",
"2103300": "53,86",
"2103400": "53,86",
"2103500": "53,86",
"2103600": "40,33",
"2103700": "40,33",
"2103800": "53,86",
"2103900": "40,33",
"2104000": "40,33",
"2104100": "40,33",
"2104200": "40,33",
"2104300": "40,33",
"2104400": "40,33",
"2104500": "40,33",
"2104600": "40,33",
"2104700": "40,33",
"2104800": "40,33",
"2104900": "40,33",
"2105000": "40,33",
"2105100": "40,33",
"2105200": "40,33",
"2105300": "53,86",
"2105300": "53,86",
"2105301": "53,86",
"2105301": "53,86",
"2105400": "40,33",
"2105400": "40,33",
"2105500": "40,33",
"2105500": "40,33",
"2105501": "40,33",
"2105501": "40,33",
"2105600": "53,86",
"2105600": "53,86",
"2105601": "53,86",
"2105700": "40,33",
"2105800": "40,33",
"2105900": "40,33",
"2106000": "40,33",
"2106100": "40,33",
"2106200": "53,86",
"2106300": "53,86",
"2106300": "53,86",
"2106400": "53,86",
"2106400": "53,86",
"2106500": "40,33",
"2106500": "40,33",
"2106600": "40,33",
"2106700": "40,33",
"2106700": "40,33",
"2106701": "53,86",
"2106800": "53,86",
"2106800": "53,86",
"2106900": "40,33",
"2107000": "40,33",
"2107100": "40,33",
"2107200": "40,33",
"2107300": "40,33",
"2107400": "40,33",
"2107500": "40,33",
"2107600": "40,33",
"2107700": "40,33",
"2107800": "53,86",
"2107900": "40,33",
"2108000": "40,33",
"2108100": "53,86",
"2108100": "53,86",
"2108200": "53,86",
"2108300": "53,86",
"2108400": "53,86",
"2108400": "53,86",
"2108500": "53,86",
"2108600": "53,86",
"2108600": "53,86",
"2108700": "40,33",
"2108800": "40,33",
"2108800": "40,33",
"2108801": "40,33",
"2108900": "40,33",
"2109000": "40,33",
"2109100": "40,33",
"2109200": "40,33",
"2109300": "40,33",
"2109400": "40,33",
"2109500": "40,33",
"2109600": "40,33",
"2109700": "40,33",
"2109800": "40,33",
"2109801": "40,33",
"2109900": "40,33",
"2110000": "40,33",
"2110100": "40,33",
"2110200": "40,33",
"2110300": "40,33",
"2110400": "40,33",
"2110500": "40,33",
"2110600": "40,33",
"2110700": "40,33",
"2110700": "40,33",
"2110800": "40,33",
"2110900": "53,86",
"2111000": "53,86",
"2111100": "53,86",
"2111200": "53,86",
"2111300": "53,86",
"2111400": "40,33",
"2111500": "40,33",
"2111600": "53,86",
"2111700": "53,86",
"2111700": "53,86",
"2111800": "53,86",
"2111900": "53,86",
"2112000": "53,86",
"2112100": "40,33",
"2112200": "40,33",
"2112300": "40,33",
"2112300": "40,33",
"2112400": "40,33",
"2112400": "40,33",
"2112500": "40,33",
"2112500": "40,33",
"2112600": "53,86",
"2200100": "53,28",
"2300100": "47,30",
"2300100": "61,78",
"2300200": "47,30",
"2400100": "56,40",
"2400200": "56,40",
"2400200": "56,40",
"2400200": "56,40",
"2400201": "56,40",
"2400201": "56,40",
"2400300": "56,40",

};

  let resultados = [];
  const mvaGrupos = new Map();
  const produtosSelecionadosMVA = new Map();

  function getIcmsCredit(produto) {
    // Busca a tag pICMS dentro do produto
    const pICMS = produto.querySelector('pICMS')?.textContent;
    
    // Se encontrou a tag pICMS, converte para número
    if (pICMS) {
      return parseFloat(pICMS) / 100; // Converte de porcentagem para decimal
    } 
    
    // Se não encontrar a tag pICMS, mantém o comportamento original baseado na origem
    const orig = produto.querySelector('orig')?.textContent || '0';
    return orig === '1' ? 0.04 : 0.07;
  }

  function calcularCenario(mva, valores, icmsCredit) {
    const vlProdutos = valores.valorTotal;
    const vlIpi = valores.ipiTotal;
    const alqMva = parseFloat(mva.replace(',', '.'));
    const alqOrigem = icmsCredit;

    const resultado = vlProdutos + vlIpi;
    const baseCalculo = resultado * (1 + (alqMva / 100));
    const alqIcms = 17 / 100;
    const valorCredito = baseCalculo * alqIcms;

    return {
      valorGuia: valorCredito - (vlProdutos * alqOrigem),
      icmsCredit: alqOrigem * 100
    };
  }

  function createMVASelect(defaultValue = '', produtoIndex) {
    const selectedMVA = produtosSelecionadosMVA.get(parseInt(produtoIndex)) || defaultValue;
    
    return `
      <select class="mva-select" id="select-mva-${produtoIndex}" onchange="atualizarMVASelect(this, ${produtoIndex})">
        <option value="">Selecione MVA</option>
        ${opcoesMVA.map(mva => `
          <option value="${mva}" ${mva === selectedMVA ? 'selected' : ''}>
            ${mva}%
          </option>
        `).join('')}
      </select>
      <span class="mva-display" id="mva-display-${produtoIndex}">${selectedMVA ? selectedMVA + '%' : ''}</span>
    `;
  }

  function atualizarMVASelect(select, produtoIndex) {
    const selectedMVA = select.value;
    const mvaDisplay = document.getElementById(`mva-display-${produtoIndex}`);
    
    if (mvaDisplay) {
      mvaDisplay.textContent = selectedMVA ? selectedMVA + '%' : '';
    }
    
    // Armazena a MVA selecionada para o produto específico
    produtosSelecionadosMVA.set(parseInt(produtoIndex), selectedMVA);
    
    // Garante que o valor selecionado permaneça no dropdown
    select.value = selectedMVA;
    
    processarXML();
  }

  function atualizarMVA(cest, novoValor, produtoIndex) {
    const produto = document.querySelector(`#produto-${produtoIndex}`);
    if (produto) {
      const mvaInput = produto.querySelector('.mva-input');
      if (mvaInput) {
        mvaInput.value = novoValor;
      }
    }
    processarXML();
  }

  function processarXML() {
    const arquivoInput = document.getElementById('xml-upload');
    const arquivo = arquivoInput.files[0];

    if (!arquivo) {
      alert("Por favor, selecione um arquivo XML.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
      const xmlConteudo = event.target.result;
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlConteudo, "application/xml");

      mvaGrupos.clear();
      resultados = [];

      const produtos = xmlDoc.querySelectorAll('det');
      produtos.forEach((produto, index) => {
        const produtoIndex = produto.getAttribute('nItem');
        const CEST = produto.querySelector('CEST')?.textContent;
        const vProd = parseFloat(produto.querySelector('vProd')?.textContent || '0');
        const vIPI = parseFloat(produto.querySelector('IPI vIPI')?.textContent || '0');
        const icmsCredit = getIcmsCredit(produto);

        let mva = '';
        if (CEST && CEST !== 'Não especificado') {
          const mvaInput = document.querySelector(`#mva-${CEST}`);
          mva = mvaInput && mvaInput.value ? mvaInput.value : cestMvaMap[CEST] || '';
        } else {
          mva = produtosSelecionadosMVA.get(parseInt(produtoIndex)) || '';
        }

        if (mva) {
          if (!mvaGrupos.has(mva)) {
            mvaGrupos.set(mva, {
              valorTotal: 0,
              ipiTotal: 0,
              icmsCredit: icmsCredit
            });
          }
          const grupo = mvaGrupos.get(mva);
          grupo.valorTotal += vProd;
          grupo.ipiTotal += vIPI;
        }
      });

      const container = document.getElementById('calculos-container');
      container.innerHTML = '';

      mvaGrupos.forEach((valores, mva) => {
        const bloco = document.createElement('div');
        bloco.classList.add('calculo');

        const resultado = calcularCenario(mva, valores, valores.icmsCredit);
        resultados.push(resultado.valorGuia);
        
        const creditoValor = valores.valorTotal * valores.icmsCredit;

        bloco.innerHTML = `
          <h2>Cálculo MVA ${mva}%</h2>
          <label>Valor dos produtos:</label>
          <input type="text" class="vl-produtos" value="${valores.valorTotal.toFixed(2)}" readonly>
          <label>IPI e Despesas:</label>
          <input type="text" class="vl-ipi" value="${valores.ipiTotal.toFixed(2)}" readonly>
          <div class="credit-info">
            <label>Crédito ICMS ${(valores.icmsCredit * 100).toFixed(0)}%:</label>
            <span>${creditoValor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
          </div>
          <label>Valor Guia:</label>
          <input type="text" class="valor-guia" value="${resultado.valorGuia.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}" readonly>
        `;

        container.appendChild(bloco);
      });

      const total = resultados.reduce((acc, curr) => acc + curr, 0);
      document.getElementById('total-valor-guia').value = total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

      atualizarInformacoesNota(xmlDoc, produtos);
    };

    reader.readAsText(arquivo);
  }

  function atualizarInformacoesNota(xmlDoc, produtos) {
    const vNF = xmlDoc.querySelector('vNF');
    const emitente = xmlDoc.querySelector('emit > xNome');
    const destinatario = xmlDoc.querySelector('dest > xNome');
    const nNF = xmlDoc.querySelector('nNF');
    const vICMSST = xmlDoc.querySelector('vICMSST');
    const chNFe = xmlDoc.querySelector('chNFe');
    
    const informacoes = `
      <div class="nota-fiscal-info">
        <h3>Informações da Nota Fiscal</h3>
        <p><strong>Número da NF:</strong> ${nNF ? nNF.textContent : 'Não encontrado'}</p>
        <p><strong>Chave NF-e:</strong> ${chNFe ? chNFe.textContent : 'Não encontrado'}</p>
        <p><strong>Emitente:</strong> ${emitente ? emitente.textContent : 'Não encontrado'}</p>
        <p><strong>Destinatário:</strong> ${destinatario ? destinatario.textContent : 'Não encontrado'}</p>
        <p><strong>Valor da Nota (vNF):</strong> ${vNF ? vNF.textContent : 'Não encontrado'}</p>
        <p><strong>ICMS ST destacado:</strong> ${vICMSST ? vICMSST.textContent : 'Sem destaque'}</p>

      </div>
      <div class="produtos-info">
        <h2>Informações dos Produtos</h2>
        ${Array.from(produtos).map((produto, index) => {
          const nItem = produto.getAttribute('nItem');
          const xProd = produto.querySelector('xProd')?.textContent || 'Não especificado';
          const vProd = produto.querySelector('vProd')?.textContent || 'Não especificado';
          const NCM = produto.querySelector('NCM')?.textContent || 'Não especificado';
          const CEST = produto.querySelector('CEST')?.textContent || 'Não especificado';
          const CFOP = produto.querySelector('CFOP')?.textContent || 'Não especificado';
          const icmsCredit = getIcmsCredit(produto);
          const pICMS = produto.querySelector('pICMS')?.textContent;
          const orig = produto.querySelector('orig')?.textContent || '0';
          const CST = produto.querySelector('CST')?.textContent || 'N/A';
          const origCST = `${orig}${CST}`;
          const creditoValor = parseFloat(vProd) * icmsCredit;
          
          // Para produtos sem CEST, use o valor anteriormente selecionado se existir
          const defaultMVA = CEST !== 'Não especificado' 
                            ? cestMvaMap[CEST] || '' 
                            : produtosSelecionadosMVA.get(parseInt(nItem)) || '';

          return `
            <div class="produto-item" id="produto-${nItem}">
              <p><strong>Produto ${nItem}</strong></p>
              <ul>
                <li><strong>Produto:</strong> ${xProd}</li>
                <li><strong>NCM:</strong> ${NCM}</li>
                <li>
                  <strong>CEST:</strong> ${CEST}
                  ${CEST === 'Não especificado' 
                    ? createMVASelect(defaultMVA, nItem)
                    : `<input type="text" 
                        class="mva-input" 
                        id="mva-${CEST}"
                        value="${defaultMVA}"
                        placeholder="MVA %"
                        onchange="atualizarMVA('${CEST}', this.value, ${index})">
                      <span class="mva-display">${defaultMVA}%</span>`
                  }
                </li>
                <li><strong>CFOP:</strong> ${CFOP}</li>
                <li>
                  <strong>CST:</strong> ${origCST}
                  <div class="credit-info">
                    <strong>Crédito ICMS ${(icmsCredit * 100).toFixed(0)}%:</strong>
                    ${creditoValor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                    ${pICMS ? `<br><small>(Alíquota do XML: ${pICMS}%)</small>` : ''}
                  </div>
                </li>
                <li><strong>Valor:</strong> ${vProd}</li>
              </ul>
            </div>
          `;
        }).join('')}
      </div>
    `;

    document.getElementById('informacoes-nota').innerHTML = informacoes;
    
    // Após renderizar os selects, certifique-se de que os valores selecionados estejam mantidos
    produtos.forEach((produto) => {
      const nItem = produto.getAttribute('nItem');
      const CEST = produto.querySelector('CEST')?.textContent;
      
      if (CEST === 'Não especificado' || !CEST) {
        const storedMVA = produtosSelecionadosMVA.get(parseInt(nItem));
        const selectElement = document.getElementById(`select-mva-${nItem}`);
        
        if (selectElement && storedMVA) {
          selectElement.value = storedMVA;
        }
      }
    });
  }

  function adicionarCalculo() {
    const container = document.getElementById('calculos-container');
    const novoBloco = document.createElement('div');
    novoBloco.classList.add('calculo');
    novoBloco.innerHTML = `
      <h2>Novo Cálculo MVA</h2>
      <label>MVA (%):</label>
      <select class="mva-manual">
        ${opcoesMVA.map(mva => `<option value="${mva}">${mva}%</option>`).join('')}
      </select>
      <label>Valor dos produtos:</label>
      <input type="text" class="vl-produtos-manual" value="0,00">
      <label>IPI e Despesas:</label>
      <input type="text" class="vl-ipi-manual" value="0,00">
      <label>Crédito ICMS:</label>
      <select class="icms-credit-manual">
        <option value="0.07">7%</option>
        <option value="0.04">4%</option>
      </select>
      <button onclick="calcularManual(this)">Calcular</button>
      <label>Valor Guia:</label>
      <input type="text" class="valor-guia-manual" readonly>
    `;
    container.appendChild(novoBloco);
  }

  function calcularManual(btn) {
    const bloco = btn.closest('.calculo');
    const mva = bloco.querySelector('.mva-manual').value;
    const vlProdutos = parseFloat(bloco.querySelector('.vl-produtos-manual').value.replace('.', '').replace(',', '.'));
    const vlIpi = parseFloat(bloco.querySelector('.vl-ipi-manual').value.replace('.', '').replace(',', '.'));
    const icmsCredit = parseFloat(bloco.querySelector('.icms-credit-manual').value);
    
    const valores = {
      valorTotal: vlProdutos,
      ipiTotal: vlIpi,
      icmsCredit: icmsCredit
    };
    
    const resultado = calcularCenario(mva, valores, icmsCredit);
    bloco.querySelector('.valor-guia-manual').value = resultado.valorGuia.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    
    // Atualizar o total
    atualizarTotal();
  }

  function atualizarTotal() {
    const guias = document.querySelectorAll('.valor-guia, .valor-guia-manual');
    let total = 0;
    guias.forEach(guia => {
      if (guia.value) {
        total += parseFloat(guia.value.replace('.', '').replace(',', '.'));
      }
    });
    
    document.getElementById('total-valor-guia').value = total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  }

  function removerUltimoCalculo() {
    const container = document.getElementById('calculos-container');
    const blocos = container.querySelectorAll('.calculo');
    if (blocos.length > 0) {
      container.removeChild(blocos[blocos.length - 1]);
      
      // Atualizar o total
      atualizarTotal();
    }
  }

  window.onload = () => {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('xml-upload');

    // Se produtosSelecionadosMVA não existir, inicialize-o
    if (!window.produtosSelecionadosMVA) {
      window.produtosSelecionadosMVA = new Map();
    }

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type === 'text/xml' || files[0].name.endsWith('.xml')) {
        fileInput.files = files;
        processarXML();
      } else {
        alert("Por favor, selecione apenas arquivos XML.");
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        processarXML();
      }
    });
  };
</script>
</body>
</html>
